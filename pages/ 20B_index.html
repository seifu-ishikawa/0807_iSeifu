<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Web テトリス</title>

<style>
  body {font-family: sans-serif; text-align: center; background:#222; color:#fff;}
  #info {margin: 10px auto; width: 20rem;}
  #info div {margin-bottom: 4px; font-size: 1.2rem;}
  canvas {border: 2px solid #555; background:#111;}
</style>
</head>

<body>
<h1>テトリス</h1>

<div id="info">
  <div id="score">スコア: 0</div>
  <div id="lines">ライン: 0</div>
  <div id="level">レベル: 1</div>
  <div id="state">ゲーム中</div>
</div>

<canvas id="game" width="300" height="600"></canvas>

<script>
/* ----------  定数・グローバル変数  ---------- */
const COLS = 10;           // 横幅（ブロック数）
const ROWS = 20;           // 高さ（ブロック数）
const BLOCK_SIZE = 30;     // 1ブロックのピクセルサイズ
const COLORS = [           // それぞれの形に対応づく色
  '#00f0f0', '#0000f0', '#f0a000',
  '#ff8000', '#00f0a0', '#a0f000',
  '#f00000'
];
const SHAPES = [           // 各形の回転ごとの座標配列
  // I
  [ [[0,1],[1,1],[2,1],[3,1]],
    [[2,0],[2,1],[2,2],[2,3]],
    [[0,2],[1,2],[2,2],[3,2]],
    [[1,0],[1,1],[1,2],[1,3]] ],
  // J
  [ [[0,0],[0,1],[1,1],[2,1]],
    [[1,0],[2,0],[1,1],[1,2]],
    [[0,1],[1,1],[2,1],[2,2]],
    [[1,0],[1,1],[0,2],[1,2]] ],
  // L
  [ [[2,0],[0,1],[1,1],[2,1]],
    [[1,0],[1,1],[1,2],[2,2]],
    [[0,1],[1,1],[2,1],[0,2]],
    [[0,0],[1,0],[1,1],[1,2]] ],
  // O
  [ [[1,0],[2,0],[1,1],[2,1]],
    [[1,0],[2,0],[1,1],[2,1]],
    [[1,0],[2,0],[1,1],[2,1]],
    [[1,0],[2,0],[1,1],[2,1]] ],
  // S
  [ [[1,1],[2,1],[0,2],[1,2]],
    [[1,0],[1,1],[2,1],[2,2]],
    [[1,1],[2,1],[0,2],[1,2]],
    [[1,0],[1,1],[2,1],[2,2]] ],
  // T
  [ [[1,0],[0,1],[1,1],[2,1]],
    [[1,0],[1,1],[2,1],[1,2]],
    [[0,1],[1,1],[2,1],[1,2]],
    [[1,0],[0,1],[1,1],[1,2]] ],
  // Z
  [ [[0,0],[1,0],[1,1],[2,1]],
    [[2,0],[1,1],[2,1],[1,2]],
    [[0,0],[1,0],[1,1],[2,1]],
    [[2,0],[1,1],[2,1],[1,2]] ]
];

let canvas = document.getElementById('game');
let ctx = canvas.getContext('2d');
let board = createMatrix(ROWS, COLS);          // 空きマット
let piece = null;                              // 現在のピース
let dropStart = Date.now();                    // 下ろしタイミング
let dropInterval = 500;                        // 初期落下速度(ms)
let score = 0;
let linesCleared = 0;
let level = 1;
let stateEl = document.getElementById('state');
let paused = false;

/* ----------  ユーティリティ ---------- */
function createMatrix(rows, cols) {
  const matrix = [];
  while (rows--) matrix.push(new Array(cols).fill(0));
  return matrix;
}

function randomPiece() {
  const index = Math.floor(Math.random() * SHAPES.length);
  return {shape: index, rotation: 0, x: Math.floor(COLS/2)-2, y: 0};
}

function collide(board, piece, offsetX=0, offsetY=0, rot = piece.rotation) {
  const shape = SHAPES[piece.shape][rot];
  for (let [bx, by] of shape) {
    const x = piece.x + bx + offsetX;
    const y = piece.y + by + offsetY;
    if (x < 0 || x >= COLS || y >= ROWS) return true; // 下なら外れ
    if (y < 0) continue; // 上からは通す
    if (board[y][x]) return true; // 既に占領済み
  }
  return false;
}

function merge(board, piece) {
  const shape = SHAPES[piece.shape][piece.rotation];
  for (let [bx, by] of shape) {
    const x = piece.x + bx;
    const y = piece.y + by;
    if (y >= 0) board[y][x] = piece.shape + 1; // 色は1以上にする
  }
}

function rotatePiece(piece) {
  const newRot = (piece.rotation + 1) % 4;
  if (!collide(board, piece, 0, 0, newRot)) {
    piece.rotation = newRot;
  }
}

function movePiece(dx, dy) {
  if (!collide(board, piece, dx, dy)) {
    piece.x += dx;
    piece.y += dy;
  } else if (dy > 0) { // 下に着地したら固定
    merge(board, piece);
    const cleared = sweepLines();
    if (cleared) {
      linesCleared += cleared;
      score += getScore(cleared);
      level = Math.floor(linesCleared / 10) + 1;
      dropInterval = Math.max(500 - (level - 1) * 50, 120);
      document.getElementById('level').innerText = 'レベル: ' + level;
      document.getElementById('lines').innerText = 'ライン: ' + linesCleared;
      document.getElementById('score').innerText = 'スコア: ' + score;
    }
    piece = randomPiece();
    if (collide(board, piece)) { // 置けないならゲームオーバー
      stateEl.innerText = 'ゲームオーバー! もう一度クリックしてね.';
      document.removeEventListener('keydown', keyMove);
      alert('ゲームオーバー');
      resetGame();
    }
  }
}

function dropPiece() {
  movePiece(0, 1);
}

function getScore(lines) {
  // 典型的なテトリススコア
  const points = [0, 100, 300, 500, 800];
  return points[lines] || 0;
}

function sweepLines() {
  let lines = 0;
  outer: for (let y = ROWS - 1; y >= 0; --y) {
    for (let x = 0; x < COLS; ++x) {
      if (!board[y][x]) continue outer;
    }
    // その行を削除
    board.splice(y, 1);
    board.unshift(new Array(COLS).fill(0));
    ++lines;
    y++; // 同じ行を再チェック
  }
  return lines;
}

function drawMatrix(matrix, offsetX, offsetY) {
  matrix.forEach((row, y) =>
    row.forEach((value, x) => {
      if (value !== 0) {
        ctx.fillStyle = COLORS[value - 1];
        ctx.fillRect((x + offsetX) * BLOCK_SIZE,
                     (y + offsetY) * BLOCK_SIZE,
                     BLOCK_SIZE, BLOCK_SIZE);
        ctx.strokeStyle = '#000';
        ctx.strokeRect((x + offsetX) * BLOCK_SIZE,
                       (y + offsetY) * BLOCK_SIZE,
                       BLOCK_SIZE, BLOCK_SIZE);
      }
    })
  );
}

function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawMatrix(board, 0, 0);
  if (piece) {
    drawMatrix(SHAPES[piece.shape][piece.rotation], piece.x, piece.y);
  }
}

/* ----------  ゲームループ ---------- */
function update() {
  if (paused) return;

  const now = Date.now();
  const delta = now - dropStart;
  if (delta > dropInterval) {
    dropPiece();
    dropStart = Date.now();
  }
  render();
  requestAnimationFrame(update);
}

function resetGame() {
  board = createMatrix(ROWS, COLS);
  piece = randomPiece();
  dropStart = Date.now();
  score = 0;
  linesCleared = 0;
  level = 1;
  dropInterval = 500;
  document.getElementById('score').innerText = 'スコア: 0';
  document.getElementById('lines').innerText = 'ライン: 0';
  document.getElementById('level').innerText = 'レベル: 1';
  stateEl.innerText = 'ゲーム中';
  document.addEventListener('keydown', keyMove);
}

/* ----------  操作 ---------- */
function keyMove(event) {
  if (!piece) return;
  switch (event.key) {
    case 'ArrowLeft':
      event.preventDefault();
      movePiece(-1, 0);
      break;
    case 'ArrowRight':
      event.preventDefault();
      movePiece(1, 0);
      break;
    case 'ArrowDown':
      event.preventDefault();
      dropPiece();
      dropStart = Date.now();
      break;
    case 'ArrowUp':
      event.preventDefault();
      rotatePiece(piece);
      break;
    case ' ':
      event.preventDefault();
      // 連打して落下させる
      while (!collide(board, piece, 0, 1)) piece.y++;
      movePiece(0, 1); // 1フレームだけ固定
      break;
    case 'p':
    case 'P':
      paused = !paused;
      stateEl.innerText = paused ? '一時停止' : 'ゲーム中';
      break;
  }
}

/* ----------  初期化 ---------- */
resetGame();
update();
</script>
</body>
</html>